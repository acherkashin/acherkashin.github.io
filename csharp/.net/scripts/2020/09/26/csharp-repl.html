<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta name="google-site-verification" content="zNIoPhlH09hYt1KC8ZJ3TZr6hzDb9l3_04kEKsPLUCQ" />
<meta name="yandex-verification" content="c3c64d8eecf0f2fa" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href=/assets/favicon/favicon-32x32.png>
<link rel="icon" type="image/png" sizes="16x16" href=/assets/favicon/favicon-16x16.png>
<link rel="manifest" href=/assets/favicon/site.webmanifest>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>C# Interactive - REPL | Блог Черкашина Александра</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="C# Interactive - REPL" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Несколько лет назад, я заметил, что в Visual Studio появилась новая окошко “C# Interactive”. Eщё тогда я стал догадываться, что это REPL, однако только недавно решил разобраться, что оно из себя представляет и в каких случаях может быть полезно. Прежде чем мы перейдём, к “С# Interactive” давайте кратко обсудим, что же такое REPL" />
<meta property="og:description" content="Несколько лет назад, я заметил, что в Visual Studio появилась новая окошко “C# Interactive”. Eщё тогда я стал догадываться, что это REPL, однако только недавно решил разобраться, что оно из себя представляет и в каких случаях может быть полезно. Прежде чем мы перейдём, к “С# Interactive” давайте кратко обсудим, что же такое REPL" />
<link rel="canonical" href="https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html" />
<meta property="og:url" content="https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html" />
<meta property="og:site_name" content="Блог Черкашина Александра" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-26T12:00:00+03:00" />
<script type="application/ld+json">
{"headline":"C# Interactive - REPL","dateModified":"2020-09-26T12:00:00+03:00","datePublished":"2020-09-26T12:00:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html"},"description":"Несколько лет назад, я заметил, что в Visual Studio появилась новая окошко “C# Interactive”. Eщё тогда я стал догадываться, что это REPL, однако только недавно решил разобраться, что оно из себя представляет и в каких случаях может быть полезно. Прежде чем мы перейдём, к “С# Interactive” давайте кратко обсудим, что же такое REPL","url":"https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>
  <body>
    <!-- Yandex.Metrika counter -->
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(62071573, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
    });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/62071573" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
    <main class="container">
      <section class="about">
        <a href="/"><img src="/assets/portfolio.png" alt="Черкашин Александр"></a>
        <h2 id="title">
          <a href="/">Черкашин Александр</a>
        </h2>
        <p class="tagline">Разработчик</p>
        <ul class="social"><a href="https://github.com/acherkashin">
              <li>
                <i class="icon-github-circled"></i>
              </li>
            </a></ul><nav class="navigation">
            <ul>
              
                <li>
                  <a href="/about">Обо мне</a>
                </li>
              
            </ul>
          </nav><p>&copy;
          2020</p>
      </section>
      <section class="content">
        <div class="post-container">
  <a class="post-link" href="/csharp/.net/scripts/2020/09/26/csharp-repl.html">
    <h2 class="post-title">C# Interactive - REPL</h2>
  </a>
  <div class="post-meta">
    <ul class="post-categories"><li>csharp</li><li>.net</li><li>scripts</li></ul>
    <div class="post-date">
        <i class="icon-calendar"></i>
        




<span class="date">26 Сентября 2020</span>
    </div>
  </div>
  <div class="post">
    <p>Несколько лет назад, я заметил, что в Visual Studio появилась новая окошко “C# Interactive”. Eщё тогда я стал догадываться, что это REPL, однако только недавно решил разобраться, что оно из себя представляет и в каких случаях может быть полезно. Прежде чем мы перейдём, к “С# Interactive” давайте кратко обсудим, что же такое <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a></p>
<h2 id="repl">Что такое REPL?</h2>
<div class="centering">
<p><img src="/assets/repl/repl-meme.png" alt="Repl meme" /></p>
</div>
<p>REPL или “read-eval-print loop” - это интерактивная среда разработки (в командной строке), в которой пользователь вводит выражение на языке программирования, а REPL, в свою очередь, считывает (Read) его, выполняет (Eval) и отображает результат (Print), а затем этот процесс снова повторяется (Loop). Всё просто, не так ли? А чтобы было ещё проще вот небольшой пример.</p>
<div class="centering">
<p><img src="/assets/repl/repl-example.gif" alt="Repl example" /></p>
</div>
<p>Аббревиатура REPL сложилась из названий функций языка LISP, с помощью которых REPL собственно и был реализован. Примерно вот так выглядит REPL на языке LISP:</p>
<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="p">(</span><span class="nb">eval</span><span class="w"> </span><span class="p">(</span><span class="nb">read</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>
<p>REPL в C# появился вместе с <a href="https://en.wikipedia.org/wiki/Roslyn_(compiler)">Roslyn</a> и благодаря ему, так как Rolsyn изначально разрабатывался с целью предоставления разработчикам API для работы с компилятором. Подробнее об истории появления Rolsyn и о способах его использования можно почитать <a href="https://docs.microsoft.com/en-us/archive/blogs/cdndevs/adding-c-scripting-to-your-development-arsenal-part-1">здесь</a>. Там же в данной статье вы можете найти упрощенный способ реализации REPL на C#.</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span> 
<span class="p">{</span>    
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>    
    <span class="p">{</span>        
        <span class="n">ScriptState</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">scriptState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>        
        <span class="p">{</span>            
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"* "</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">input</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
            <span class="n">scriptState</span> <span class="p">=</span> <span class="n">scriptState</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span>
                <span class="n">CSharpScript</span><span class="p">.</span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ScriptOptions</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">AddImports</span><span class="p">(</span><span class="s">"System"</span><span class="p">)).</span><span class="n">Result</span> <span class="p">:</span> 
                <span class="n">scriptState</span><span class="p">.</span><span class="nf">ContinueWithAsync</span><span class="p">(</span><span class="n">input</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="repl-1">Для чего нужен REPL?</h2>
<p>Теперь вы знаете, что такое REPL, но я думаю, сейчас в вашей голове примерно следующие мысли “Окей, REPL, круто, а зачем?”. И это самый главный вопрос, ведь каждый инструмент должен решать какие-то проблемы. В нашем случае, REPL позволяет нам мгновенно увидеть результат выполнения кода, без ожидания его компиляции. К тому же вам не нужно создавать новый проект, чтобы протестировать там пару строк кода (У меня целое кладбище таких проектов).</p>
<p>Вы можете использовать REPL, чтобы ознакомиться или поиграться с API, если не уверены в том, как он работает. Давайте наконец-то откроем Visual Studio (если вы используете Rider, то там тоже есть окно “C# Interactive”) и запустим REPL, его можно найти по пути “View &gt; Other Windows &gt; C# Interactive”.</p>
<div class="centering">
<p><img src="/assets/repl/csharp-interactive-path.png" alt="C# Interactive Path" /></p>
</div>
<p>Теперь давайте представим, что мы забыли, мутирует ли объект метод <code>Concat</code> типа <code>List&lt;int&gt;</code>. Тут нам и поможет REPL.</p>
<div class="centering">
<p><img src="/assets/repl/list-concat-example.gif" alt="List concat example" /></p>
</div>
<p>Как видно из примера, метод <code>Contact</code> не мутирует существующий список, а возвращает новый, в котором содержатся элементы списков <code>list1</code>, <code>list2</code>. Необходимо подчеркнуть тот факт, что для того чтобы увидеть результат выполнения выражения, нужно чтобы оно не оканчивалось точкой с запятой, иначе результат выведен не будет.  Как вы могли заметить, в C# Interactive работает привычный нам IntelliSense, что гораздо упрощает работу.</p>
<p>К счастью, это не все возможности C# Interactive, вы можете использовать его также для изучения сторонних библиотек. Однако, он не позволяет напрямую работать с менеджером пакетов Nuget, поэтому необходимо предварительно скачать нужную вам библиотеку или, если вам необходимо изучить библиотеку которая используется в вашем проекте, можно просто указать путь к ней следующим образом:</p>
<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="n">r</span> <span class="s">"...\path\library.dll"</span>
</code></pre></div></div>
<p>Давайте посмотрим как можно использовать C# Interactive для изучения API библиотеки <a href="https://octokitnet.readthedocs.io/en/latest/">Octokit</a>.</p>
<div class="centering">
<p><img src="/assets/repl/Octokit-usage.png" alt="Octokit usage" /></p>
</div>
<p>Также нужно отметить, что вам не обязательно запускать Visual Studio, чтобы использовать REPL. Вы можете запустить <em>Developer Command Prompt for VS</em> и выполнить команду <code>csi</code>.</p>
<div class="centering">
<p><img src="/assets/repl/csi-util.png" alt="Usage csi util" /></p>
</div>
<p>C# Repl доступен не только на Windows. На Linux и Mac может использоваться <a href="https://www.mono-project.com/docs/tools+libraries/tools/repl/">Mono C# Repl</a>.</p>
<h2 id="dotnet-script">DotNet Script</h2>
<p>C# Interactive является не единственным REPL окружением для C#, существует ещё минимум 2:</p>
<ul>
<li><a href="http://scriptcs.net/">Script-CS</a></li>
<li><a href="https://github.com/filipw/dotnet-script">DotNet-Script</a></li>
</ul>
<p>Данные окружения позволяют работать с менеджером пакетов Nuget. Но в данной статье я рассмотрю только <a href="https://github.com/filipw/dotnet-script">DotNet-Script</a>.</p>
<p>Давайте запустим тот же самый пример с библиотекой Octokit, используя DotNet Script (об установке dotnet script можно почитать <a href="https://github.com/filipw/dotnet-script">здесь</a>).</p>
<div class="centering">
<p><img src="/assets/repl/dotnet-script-ubuntu.png" alt="DotNet Script" /></p>
</div>
<p>Для запуска dotnet script необходимо запустить в консоли <code>dotnet script</code> или <code>dotnet-script</code>. Как вы уже заметили из примера, для подключения библиотеки из Nuget используется следующая запись: <code>#r &quot;nuget: &lt;library&gt;, &lt;version&gt;&quot;</code>, в нашем случае - это <code>#r &quot;nuget: Octokit, 0.48.0&quot;</code>. Первый запуск команды займет некоторое время, так как будет происходить скачивание библиотеки, но в дальнейшем, запуск команды будет занимать гораздо меньше времени, так как библиотека будет закэширована.</p>
<p>DotNet Script использует .net core и поэтому является кросплатформенным, благодаря чему вы можете запустить его на любой платформе.</p>
<p>Однако, чтобы получить intellisense для dotnet script вам необходимо использовать текстовый редактор, <a href="http://www.omnisharp.net/">поддерживающий OmniSharp</a>. Я покажу как это сделать на примере уже знакомого нам, примера с Octokit в Visual Studio Code. Для начала нам нужно инициализировать новый проект dotnet script с помощью команды <code>dotnet script init</code>.</p>
<div class="centering">
<p><img src="/assets/repl/dotnet-script-init.png" alt="Инициализация проекта DotNet Script" /></p>
</div>
<p>Затем необходимо установить <a href="https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp">C# Extension</a> для Visual Studio Code. После чего необходимо вставить уже знакомый нам пример в файл <code>main.csx</code>.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="p">!/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">env</span> <span class="n">dotnet</span><span class="p">-</span><span class="n">script</span>
<span class="err">#</span><span class="n">r</span> <span class="s">"nuget: Octokit, 0.48.0"</span>
<span class="k">using</span> <span class="nn">Octokit</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">github</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GitHubClient</span><span class="p">(</span><span class="k">new</span> <span class="nf">ProductHeaderValue</span><span class="p">(</span><span class="s">"CherkashinBlogPost"</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">github</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">"acherkashin"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">Followers</span><span class="p">}</span><span class="s"> folks follow acherkashin"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">Blog</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">pullRequests</span> <span class="p">=</span> <span class="k">await</span> <span class="n">github</span><span class="p">.</span><span class="n">PullRequest</span><span class="p">.</span><span class="nf">GetAllForRepository</span><span class="p">(</span><span class="s">"storybookjs"</span><span class="p">,</span> <span class="s">"storybook"</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">pullRequests</span><span class="p">.</span><span class="nf">Count</span><span class="p">());</span>

<span class="kt">var</span> <span class="n">lastPR</span> <span class="p">=</span> <span class="n">pullRequests</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CreatedAt</span> <span class="p">&gt;</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">Subtract</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromDays</span><span class="p">(</span><span class="m">2</span><span class="p">)));</span>
<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">q</span> <span class="k">in</span> <span class="n">lastPR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">q</span><span class="p">.</span><span class="n">CreatedAt</span><span class="p">}</span><span class="s">...</span><span class="p">{</span><span class="n">q</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Login</span><span class="p">}</span><span class="s">...</span><span class="p">{</span><span class="n">q</span><span class="p">.</span><span class="n">Title</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Как вы можете увидеть из скриншота ниже, intellisense в VsCode работает также хорошо как, и в Visual Studio.</p>
<div class="centering">
<p><img src="/assets/repl/vscode-intellisense.png" alt="IntelliSence в Vs Code" /></p>
</div>
<p>Итак, в начале я сказал, что вам не нужно создавать пустой проект, для того, чтобы протестировать какой-то кусок кода или поиграться с API библиотеки, а в итоге делаю всё с точность до наоборот. Дело в том, что dotnet script представляет собой не только REPL, но и полноценный скриптовый язык. Теперь вы можете писать скрипты на своём любимом языке 😉 и забыть о изучении bash, python, PowerShell… Подробнее об этом вы можете узнать в статье <a href="https://itnext.io/hitchhikers-guide-to-the-c-scripting-13e45f753af9">Hitchhiker’s Guide to the C# scripting</a>.</p>
<p>Напоследок хочется отметить, что dotnet scripts также предоставляет возможность отладки. Таким образом вы сможете не только писать скрипты на C#, но и удобно отлаживать их.</p>
<div class="centering">
<p><img src="/assets/repl/debugging.png" alt="Отладка main.csx файла в Visual Studio Code" /></p>
</div>
<p>Если вам понравилась данная тема, то вы можете подробнее познакомиться с dotnet scripts в следующей статье <a href="https://www.strathweb.com/2017/12/c-repl-for-net-core-2-0-and-load-support-from-nuget-0-16-dotnet-script-is-out/">C# REPL for .NET Core 2.0 and #load support from Nuget – dotnet-script 0.16 is out</a>.</p>
<h2 id="section">Полезные ссылки</h2>
<ul>
<li><a href="https://medium.com/@kaylumah/using-c-code-in-your-git-hooks-66e507c01a0f">Using C# code in your git hooks</a></li>
<li><a href="https://github.com/filipw/dotnet-script">Ссылка на репозиторий dotnet-script</a></li>
<li><a href="https://habr.com/ru/post/273037/">Интерактивный C#</a></li>
<li><a href="https://channel9.msdn.com/Events/Visual-Studio/Connect-event-2015/103?WT.mc_id=-blog-scottha">Introducing the Visual Studio ‘C# REPL’</a></li>
<li><a href="https://medium.com/@iliasshaikh/c-scripting-with-vscode-a-recipe-c672dd44d6">C# Scripting with VSCode — A recipe</a></li>
<li><a href="https://itnext.io/hitchhikers-guide-to-the-c-scripting-13e45f753af9">Hitchhiker’s Guide to the C# scripting</a></li>
</ul>

  </div><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html';
      this.page.identifier = 'https://www.cherkashin.dev/csharp/.net/scripts/2020/09/26/csharp-repl.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://cherkashin-dev.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

      </section>
    </main>
  </body>
</html>
